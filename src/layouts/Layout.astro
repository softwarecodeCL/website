---

const navItems = [
  { label: 'Inicio', href: '/' },
  { label: 'Software a medida', href: '/desarrollo-web-a-medida' },
  { label: 'Blog', href: '/blog' },
];


export interface Props {
  title?: string;
  description?: string;
  image?: string; // puede venir relativo (/img.png) o absoluto
  url?: string;   // opcional, pero lo calculamos igual
  type?: 'website' | 'article';
  publishedTime?: string; // para posts (ISO)
  modifiedTime?: string;  // para posts (ISO)
}

const currentPath = Astro.url.pathname;

// Base del sitio (una sola fuente de verdad)
const SITE_URL = 'https://www.softwarecode.cl';
const SITE_NAME = 'SoftwareCode.cl';
const DEFAULT_IMAGE = '/logosc-original.png';

const {
  title = `${SITE_NAME} - Desarrollo de Software a Medida`,
  description = 'Soluciones digitales: desarrollo de software, CRM, ERP, apps móviles, SEO y marketing digital.',
  image = DEFAULT_IMAGE,
  type = 'website',
  publishedTime,
  modifiedTime,
} = Astro.props;

// URL real de la página
const pageUrl = new URL(currentPath, SITE_URL).toString();

// Normaliza imagen a absoluta
const imageUrl = new URL(image.startsWith('http') ? image : image || DEFAULT_IMAGE, SITE_URL).toString();

// Breadcrumbs (home + segmento(s))
const segments = currentPath.split('/').filter(Boolean);
const breadcrumbItems = [
  { name: 'Inicio', item: SITE_URL },
  ...segments.map((seg, i) => {
    const item = new URL('/' + segments.slice(0, i + 1).join('/'), SITE_URL).toString();
    const pretty =
      seg
        .replace(/-/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase());
    return { name: pretty, item };
  }),
];

// JSON-LD base (Organization + WebSite + WebPage + BreadcrumbList)
const jsonLd: any[] =  [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": `${SITE_URL}/#organization`,
    "name": SITE_NAME,
    "url": SITE_URL,
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/logosc-original.png", SITE_URL).toString()
    },
    "contactPoint": [
      {
        "@type": "ContactPoint",
        "contactType": "sales",
        "telephone": "+56-9-8839-6128",
        "areaServed": "CL",
        "availableLanguage": ["es"]
      }
    ]
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": `${SITE_URL}/#website`,
    "url": SITE_URL,
    "name": SITE_NAME,
    "publisher": { "@id": `${SITE_URL}/#organization` },
    "inLanguage": "es-CL",
    "potentialAction": {
      "@type": "SearchAction",
      "target": `${SITE_URL}/blog?search={search_term_string}`,
      "query-input": "required name=search_term_string"
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": `${pageUrl}#webpage`,
    "url": pageUrl,
    "name": title,
    "description": description,
    "isPartOf": { "@id": `${SITE_URL}/#website` },
    "about": { "@id": `${SITE_URL}/#organization` },
    "inLanguage": "es-CL",
    "primaryImageOfPage": {
      "@type": "ImageObject",
      "url": imageUrl
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": breadcrumbItems.map((b, idx) => ({
      "@type": "ListItem",
      "position": idx + 1,
      "name": b.name,
      "item": b.item
    }))
  }
];

// Si es un post (article), añade Article schema
if (type === 'article' && publishedTime) {
  jsonLd.push({
    '@context': 'https://schema.org',
    '@type': 'Article',
    mainEntityOfPage: { '@type': 'WebPage', '@id': `${pageUrl}#webpage` },
    headline: title,
    description,
    image: [imageUrl],
    author: {
      '@type': 'Organization',
      name: SITE_NAME,
      url: SITE_URL,
    },
    publisher: { '@id': `${SITE_URL}/#organization` },
    datePublished: publishedTime,
    dateModified: modifiedTime || publishedTime,
    inLanguage: 'es-CL',
  });
}
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{title}</title>
    <meta name="description" content={description} />

    <link rel="canonical" href={pageUrl} />

    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta name="google-site-verification" content="Kgk8BM0ZZ_WuBak7aBk3N6Egj4ZqfPHt7e5TqXKjhho" />

    <meta name="theme-color" content="#6f42c1" />

    <!-- Open Graph -->
    <meta property="og:locale" content="es_CL" />
    <meta property="og:type" content={type} />
    <meta property="og:site_name" content={SITE_NAME} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:image:alt" content={title} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={imageUrl} />

    <!-- JSON-LD -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify(jsonLd)}
    />


    <link rel="icon" href="/favicon.svg" />
    <link rel="icon" type="image/png" href="/logosc-original.png" />

    <!-- Estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/plugins/themify-icons/themify-icons.css">
    <link rel="stylesheet" href="/plugins/slick/slick.css">
    <link rel="stylesheet" href="/plugins/slick/slick-theme.css">
    <link rel="stylesheet" href="/plugins/fancybox/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/plugins/aos/aos.css">
    <link rel="stylesheet" href="/css/style.css">

    <style>
      html, body { margin:0; padding:0; max-width:100vw; overflow-x:hidden; }
    </style>

    <!-- Google Tag Manager (ojo: elimina tu </script> suelto antes de esto) -->
    <script>
      (function(w,d,s,l,i){w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-KCK6Z8MQ');
    </script>
  </head>

  <body>
<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KCK6Z8MQ"
  height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End GTM -->

<!-- Navbar MODERNO (Bootstrap 5.3.x) -->
<nav class="navbar navbar-expand-lg main-nav sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img src="/logosc-original.png" alt="logo" class="nav-logo" loading="lazy" style="max-width: 40%;">
    </a>

    <!-- Toggler moderno -->
    <button class="navbar-toggler hamburger collapsed d-lg-none" type="button"
      data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span></span><span></span><span></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
  {navItems.map(item => {
    const isActive =
      item.href === '/'
        ? currentPath === '/'
        : currentPath.startsWith(item.href);

    return (
      <li class="nav-item">
        <a
          href={item.href}
          class={`nav-link nav-link-modern ${isActive ? 'active' : ''}`}
        >
          {item.label}
        </a>
      </li>
    );
  })}

  <li class="nav-item ms-lg-2">
    <a class="btn btn-cta" href="https://wa.me/56988396128" target="_blank">⚡Cotizar</a>
  </li>
</ul>

    </div>
  </div>
</nav>

    <!-- Contenido principal -->
    <slot />


    <div class="contacto" id="contacto">
	<a href="https://wa.me/56988396128?text=¡Hola!%20Quiero%20más%20información." 
	 class="whatsapp-float" 
   id="whatsapp-boton"
	 target="_blank">
	<img src="https://img.icons8.com/color/48/000000/whatsapp.png" alt="WhatsApp">
  </a>

  <script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('whatsapp-boton');
    if (btn) {
      btn.addEventListener('click', () => {
        gtag('event', 'conversion', {
          'send_to': 'AW-17146702154/Jq-TCLf0ltIaEMrSl_A_',
          'value': 1.0,
          'currency': 'CLP'
        });
      });
    }
  });
</script>

    <!-- Scripts -->
    <script src="/plugins/jquery/jquery.min.js" is:inline></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/plugins/slick/slick.min.js" is:inline></script>
    <script src="/plugins/syotimer/jquery.syotimer.min.js" is:inline></script>
    <script src="/plugins/fancybox/jquery.fancybox.min.js" is:inline></script>
    <script src="/plugins/aos/aos.js" is:inline></script>
    <script src="/js/script.js" is:inline></script>
    <script src="/plugins/google-map/gmap.js" is:inline></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>

    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        AOS.init({ once: true, duration: 1000, offset: 80 });
        if (window.lucide) window.lucide.createIcons();
      });
    </script>
  </body>
</html>
<style>
  :root{
  --brand: #6f42c1;           /* morado */
  --brand-soft: rgba(111,66,193,.12);
  --text: #111;
}

/* Navbar look SaaS */
.main-nav{
  background: rgba(255,255,255,.86);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(0,0,0,.06);
}

/* Logo */
.nav-logo{
  max-width: 150px;
  height: auto;
}

/* Links modernos */
.nav-link-modern{
  display: inline-flex;
  align-items: center;
  line-height: 1;
  padding: .62rem .95rem !important;
  border-radius: 999px;
  font-weight: 700;
  font-size: .95rem;
  color: var(--text) !important;
  opacity: .85;
  transition: all .18s ease;
}

.nav-link-modern:hover{
  opacity: 1;
  background: rgba(111,66,193,.10);
  color: var(--brand) !important;
  transform: translateY(-1px);
}

/* Active (sin “subirse”) */
.nav-link-modern.active{
  opacity: 1;
  background: var(--brand-soft);
  color: var(--brand) !important;
}

/* CTA */
.btn-cta{
  border-radius: 999px;
  padding: .62rem 1.05rem;
  font-weight: 800;
  border: 1px solid rgba(111,66,193,.35);
  color: var(--brand);
  background: #fff;
  transition: all .18s ease;
  white-space: nowrap;
}

.btn-cta:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 28px rgba(0,0,0,.10);
  border-color: var(--brand);
}

/* Hamburguesa moderna */
.hamburger{
  width: 46px;
  height: 42px;
  border: 0;
  padding: 0;
  border-radius: 14px;
  background: rgba(111,66,193,.10);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  flex-direction: column;
  box-shadow: none !important;
}

.hamburger span{
  width: 22px;
  height: 2px;
  background: var(--brand);
  border-radius: 2px;
  transition: transform .18s ease, opacity .18s ease, width .18s ease;
}

/* cuando está abierto, Bootstrap quita .collapsed */
.hamburger:not(.collapsed) span:nth-child(1){
  transform: translateY(8px) rotate(45deg);
}
.hamburger:not(.collapsed) span:nth-child(2){
  opacity: 0;
  width: 16px;
}
.hamburger:not(.collapsed) span:nth-child(3){
  transform: translateY(-8px) rotate(-45deg);
}

/* Mobile dropdown más pro */
@media (max-width: 991.98px){
  .navbar-collapse{
    margin-top: .75rem;
    padding: .75rem;
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 16px;
    background: rgba(255,255,255,.95);
  }
  .nav-link-modern{
    width: 100%;
    justify-content: center;
    border-radius: 14px;
    padding: .85rem 1rem !important;
  }
  .btn-cta{
    width: 100%;
    justify-content: center;
    display: inline-flex;
  }
}

</style>


<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const nav = document.getElementById('navbarNav');
    if (!nav) return;

    nav.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (!link) return;

      const collapseEl = document.getElementById('navbarNav');
      const isShown = collapseEl.classList.contains('show');
      if (isShown && window.bootstrap) {
        window.bootstrap.Collapse.getOrCreateInstance(collapseEl).hide();
      }
    });
  });
</script>
